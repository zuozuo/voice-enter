# VoiceEnter 技术架构文档

## 概述

VoiceEnter 是一个 macOS 菜单栏工具，通过检测语音输入中的触发词（如"发送"、"Go"），自动删除触发词并按下回车键，实现语音输入后的自动发送功能。

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        VoiceEnter App                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐    ┌─────────────────────────────────┐ │
│  │   VoiceEnterApp     │    │         MenuBarView             │ │
│  │   (SwiftUI @main)   │    │   ┌───────────────────────┐     │ │
│  │                     │    │   │ • 启用/禁用开关       │     │ │
│  │  ┌───────────────┐  │    │   │ • 开始/停止监听       │     │ │
│  │  │  AppDelegate  │──┼────│   │ • 触发词列表管理      │     │ │
│  │  │  (菜单栏图标)  │  │    │   │ • 权限请求按钮        │     │ │
│  │  └───────────────┘  │    │   └───────────────────────┘     │ │
│  └─────────────────────┘    └─────────────────────────────────┘ │
│              │                              │                    │
│              ▼                              ▼                    │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                      AppState                                ││
│  │  • isMonitoring: Bool        (ObservableObject)             ││
│  │  • isEnabled: Bool                                          ││
│  │  • triggerWords: [String]                                   ││
│  │  • lastTriggered: String                                    ││
│  └──────────────────────────┬──────────────────────────────────┘│
│                             │                                    │
├─────────────────────────────┼────────────────────────────────────┤
│           VoiceEnterCore    │    (核心库)                        │
│                             ▼                                    │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                  SystemInputMonitor                         │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │ │
│  │  │ CGEventTap   │  │ currentText  │  │ debounceWorkItem │  │ │
│  │  │ (键盘事件)    │  │ (输入缓冲区)  │  │ (防抖定时器)      │  │ │
│  │  └──────┬───────┘  └──────────────┘  └──────────────────┘  │ │
│  │         │                                                   │ │
│  │         ▼                                                   │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │              handleEvent()                            │  │ │
│  │  │  1. 捕获 keyDown 事件                                 │  │ │
│  │  │  2. 提取 Unicode 字符                                 │  │ │
│  │  │  3. 追加到 currentText                               │  │ │
│  │  │  4. 启动 300ms 防抖定时器                            │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────┬──────────────────────────────────┘ │
│                            │                                     │
│                            ▼                                     │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │               TriggerWordDetector                            ││
│  │  • detect(in: "帮我写代码发送") → TriggerDetectionResult    ││
│  │  • 中文：精确匹配                                            ││
│  │  • 英文：不区分大小写                                         ││
│  └─────────────────────────┬───────────────────────────────────┘│
│                            │ 检测到触发词                        │
│                            ▼                                     │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    KeySimulator                              ││
│  │  ┌──────────────────────────────────────────────────────┐   ││
│  │  │ deleteThenEnter(deleteCount: 2)                      │   ││
│  │  │   1. 发送 2 次 Delete 键 (删除 "发送")               │   ││
│  │  │   2. 发送 1 次 Enter 键                              │   ││
│  │  └──────────────────────────────────────────────────────┘   ││
│  │                          │                                   ││
│  │                          ▼                                   ││
│  │  ┌──────────────────────────────────────────────────────┐   ││
│  │  │              CGEventPoster                            │   ││
│  │  │  CGEvent.post(tap: .cghidEventTap)                   │   ││
│  │  └──────────────────────────────────────────────────────┘   ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                  SettingsManager                             ││
│  │  • UserDefaults 持久化                                       ││
│  │  • 触发词增删改查                                             ││
│  │  • 设置变更通知                                               ││
│  └─────────────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                      macOS 系统层                                 │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────┐ │
│  │ Accessibility  │  │   CoreGraphics │  │    UserDefaults    │ │
│  │    API         │  │   (CGEvent)    │  │                    │ │
│  └────────────────┘  └────────────────┘  └────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

## 核心工作流程

```
用户语音输入 "帮我写一个函数发送"
         │
         ▼
┌─────────────────────────────────────────────────────────┐
│  macOS 语音输入 (系统自带或讯飞等)                        │
│  将语音转为文字，逐字输入到当前应用                        │
└─────────────────────────────────────────────────────────┘
         │ 键盘事件
         ▼
┌─────────────────────────────────────────────────────────┐
│  CGEventTap 捕获每个 keyDown 事件                        │
│  ┌─────────────────────────────────────────────────┐    │
│  │ currentText: "帮" → "帮我" → ... → "帮我写一个函数发送"│
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
         │ 每次输入后启动 300ms 防抖
         ▼
┌─────────────────────────────────────────────────────────┐
│  防抖结束，检测触发词                                     │
│  detect("帮我写一个函数发送")                             │
│  → 发现以 "发送" 结尾 ✓                                  │
│  → 返回 TriggerDetectionResult(triggerWord: "发送")     │
└─────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────┐
│  执行删除 + 回车                                         │
│  1. 删除 2 个字符 (发送)  → "帮我写一个函数"              │
│  2. 模拟按下 Enter 键    → 消息发送！                    │
└─────────────────────────────────────────────────────────┘
         │
         ▼
    AI 收到消息 "帮我写一个函数"
```

## 关键技术原理

### 1. CGEventTap - 系统级键盘监听

```swift
// 创建事件监听器，拦截所有 keyDown 事件
CGEvent.tapCreate(
    tap: .cgSessionEventTap,      // 会话级别监听
    place: .headInsertEventTap,   // 在事件队列头部插入
    options: .defaultTap,          // 可以修改/阻止事件
    eventsOfInterest: (1 << CGEventType.keyDown.rawValue),
    callback: { proxy, type, event, refcon in
        // 处理键盘事件
    }
)
```

**为什么需要辅助功能权限？**
- CGEventTap 可以监听和模拟任何应用的键盘输入
- 这是高权限操作，macOS 要求用户明确授权
- 通过 `AXIsProcessTrustedWithOptions` API 检查和请求权限

### 2. 防抖机制 (Debounce)

```
输入: 帮 → 我 → 写 → 代 → 码 → 发 → 送
      │    │    │    │    │    │    │
      ▼    ▼    ▼    ▼    ▼    ▼    ▼
Timer: ✗   ✗    ✗    ✗    ✗    ✗    ✓ (300ms 后触发检测)
```

**为什么需要防抖？**
- 语音输入是逐字输入的
- 如果每个字都检测，"发" 字输入时就会误判
- 等 300ms 没有新输入，说明一句话说完了

**实现方式：**
```swift
// 取消之前的定时器
debounceWorkItem?.cancel()

// 创建新的定时器
let workItem = DispatchWorkItem { [weak self] in
    self?.checkTrigger()
}
debounceWorkItem = workItem

// 300ms 后执行
DispatchQueue.main.asyncAfter(deadline: .now() + 0.3, execute: workItem)
```

### 3. 触发词检测算法

```swift
func detect(in text: String) -> TriggerDetectionResult? {
    // 1. 去除尾部空白
    var trimmedText = text.trimmingTrailingWhitespace()

    // 2. 检查每个触发词
    for triggerWord in triggerWords {
        if isEnglish(triggerWord) {
            // 英文：不区分大小写
            if trimmedText.lowercased().hasSuffix(triggerWord.lowercased()) {
                return result
            }
        } else {
            // 中文：精确匹配
            if trimmedText.hasSuffix(triggerWord) {
                return result
            }
        }
    }
    return nil
}
```

**检测规则：**
- 触发词必须在文本末尾
- 英文触发词不区分大小写（"Go"、"GO"、"go" 都有效）
- 中文触发词精确匹配
- 触发词前必须有内容（避免误发空消息）

### 4. 按键模拟

```swift
// 模拟按键的本质：创建并发送 CGEvent
func postKeyDown(keyCode: CGKeyCode) -> Bool {
    guard let event = CGEvent(
        keyboardEventSource: nil,
        virtualKey: keyCode,    // 36 = Enter, 51 = Delete
        keyDown: true
    ) else { return false }

    event.post(tap: .cghidEventTap)  // 注入到系统事件流
    return true
}
```

**常用键码：**
- `36` - Enter/Return
- `51` - Delete/Backspace

## 模块依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                     VoiceEnterApp                           │
│  (可执行文件)                                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ 依赖
┌─────────────────────────────────────────────────────────────┐
│                     VoiceEnterCore                          │
│  (静态库)                                                    │
│                                                             │
│   ┌───────────────────┐      ┌────────────────────┐        │
│   │ SystemInputMonitor│ ───▶ │TriggerWordDetector │        │
│   └───────────────────┘      └────────────────────┘        │
│            │                                                │
│            │                 ┌────────────────────┐        │
│            └───────────────▶ │   KeySimulator     │        │
│                              └────────────────────┘        │
│            │                          │                    │
│            │                          ▼                    │
│            │                 ┌────────────────────┐        │
│            │                 │   CGEventPoster    │        │
│            │                 └────────────────────┘        │
│            │                                                │
│            │                 ┌────────────────────┐        │
│            └───────────────▶ │  SettingsManager   │        │
│                              └────────────────────┘        │
│                                                             │
│   ┌───────────────────────────────────────────────────┐    │
│   │                   Protocols                        │    │
│   │  • EventPosterProtocol                            │    │
│   │  • KeySimulatorProtocol                           │    │
│   │  • SettingsManagerProtocol                        │    │
│   │  • Cancellable                                    │    │
│   └───────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块说明

### SystemInputMonitor

系统输入监听器，负责：
- 创建和管理 CGEventTap
- 捕获键盘输入事件
- 维护当前输入文本缓冲区
- 实现防抖逻辑
- 协调触发词检测和按键模拟

### TriggerWordDetector

触发词检测器，负责：
- 检测文本是否以触发词结尾
- 支持中英文混合检测
- 英文不区分大小写
- 返回检测结果（触发词、剩余内容）

### KeySimulator

按键模拟器，负责：
- 模拟 Delete 键删除字符
- 模拟 Enter 键发送消息
- 组合操作：删除后回车

### SettingsManager

设置管理器，负责：
- 使用 UserDefaults 持久化设置
- 管理触发词列表（增删改查）
- 管理启用状态
- 设置变更通知

### InputMonitor

输入监听器（用于单元测试），负责：
- 抽象的输入处理逻辑
- 可注入 Mock 依赖进行测试

## 设计原则

### 1. 协议导向设计

所有核心组件都定义了协议接口，便于：
- 单元测试时注入 Mock 实现
- 解耦模块间依赖
- 支持未来扩展

### 2. 核心库独立

VoiceEnterCore 不依赖任何 UI 框架：
- 便于复用到其他项目
- 便于编写单元测试
- 关注点分离

### 3. TDD 开发

采用测试驱动开发：
- 先写测试，后写实现
- 62 个测试用例覆盖核心逻辑
- 保证代码质量和可维护性

### 4. 防抖 + 检测分离

输入监听和触发词检测解耦：
- 各自职责清晰
- 便于独立测试和维护
- 可以独立调整防抖时间或检测算法

## 技术栈

- **语言**: Swift 5.9
- **UI 框架**: SwiftUI
- **系统框架**: CoreGraphics, Carbon, ApplicationServices
- **最低系统版本**: macOS 13.0
- **包管理**: Swift Package Manager
- **开发模式**: TDD (测试驱动开发)

## 安全考虑

1. **辅助功能权限**
   - 必须用户明确授权
   - 只在用户启用时监听
   - 不记录任何用户输入内容

2. **最小权限原则**
   - 只监听 keyDown 事件
   - 只在检测到触发词时才模拟按键
   - 不修改或阻止任何用户输入

3. **隐私保护**
   - 所有数据本地存储（UserDefaults）
   - 不联网、不上传任何数据
   - 输入缓冲区在每次回车后清空
