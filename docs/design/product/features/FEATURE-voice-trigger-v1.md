# FEATURE-voice-trigger PRD

| 项目 | 内容 |
|------|------|
| 版本 | v1 |
| 作者 | zuozuo |
| 创建日期 | 2025-12-29 |
| 更新日期 | 2025-12-29 |
| 关联 Main PRD | - |

---

## 1. 功能概述

### 1.1 背景

使用语音输入与 AI 编程助手（如 Claude Code、Cursor、Copilot Chat）交流时，每次说完都需要手动按回车发送。这个小动作打断了流畅的体验，特别是在以下场景：

- 躺着编程
- 站立办公、边踱步边思考
- 手被占用（吃东西、抱猫、抱娃）
- 手部不便（RSI、残障人士）
- 就是懒，不想动

### 1.2 目标

让用户通过语音说出触发词（如"发送"、"Go"）即可自动回车，无需手动操作键盘，实现真正的"解放双手"编程体验。

### 1.3 范围

**包含**：
- macOS 菜单栏常驻应用
- 输入监听与触发词检测
- 自动删除触发词并模拟回车
- 触发词自定义设置
- 开关状态持久化

**不包含**：
- Windows/Linux 版本（后续迭代）
- 语义智能判断（不基于 AI 判断是否说完）
- 硬件触发方案（另一个 Feature）

---

## 2. 用户故事

| ID | 用户故事 | 优先级 | 验收标准 |
|----|----------|--------|----------|
| US-001 | 作为一个躺着编程的用户，我想要说"发送"后自动按回车，以便不用起身操作键盘 | P0 | 当输入内容以"发送"结尾时，应自动删除"发送"并按下回车键 |
| US-002 | 作为一个用户，我想要自定义触发词，以便使用自己习惯的词汇 | P1 | 当用户添加自定义触发词后，新触发词应立即生效 |
| US-003 | 作为一个用户，我想要在菜单栏看到开关状态，以便随时启停功能 | P1 | 当功能开启时菜单栏显示 🎤，关闭时显示 🔇 |
| US-004 | 作为一个用户，我想要触发词被自动删除，以便发送的内容干净整洁 | P0 | 当触发回车时，触发词本身应被删除，不发送给对方 |

---

## 3. 交互设计

### 3.1 页面清单

| 页面 | 入口 | 功能说明 |
|------|------|----------|
| 菜单栏图标 | macOS 菜单栏 | 显示开关状态，点击展开菜单 |
| 下拉菜单 | 点击菜单栏图标 | 开关切换、设置入口、退出 |
| 触发词设置窗口 | 下拉菜单「触发词设置」 | 管理触发词列表 |

### 3.2 交互流程

**核心流程：语音触发回车**

```
用户语音输入内容
      |
      v
+------------------+
| 讯飞输入法识别   |
+------------------+
      |
      v
+------------------+
| VoiceEnter 监听  |
+------------------+
      |
      v
+------------------+     否     +------------------+
| 结尾是触发词？   | ---------> | 不做任何处理     |
+------------------+            +------------------+
      | 是
      v
+------------------+
| 等待 300ms       |
| 确认无后续输入   |
+------------------+
      |
      v
+------------------+
| 删除触发词       |
+------------------+
      |
      v
+------------------+
| 模拟按下回车键   |
+------------------+
```

### 3.3 界面线框图

**菜单栏下拉菜单**

```
+---------------------------+
|  🎤  VoiceEnter           |
+---------------------------+
|  ✓ 启用                   |
+---------------------------+
|  触发词设置...            |
+---------------------------+
|  关于                     |
|  退出                     |
+---------------------------+
```

**触发词设置窗口**

```
+------------------------------------------+
|          触发词设置              [x]     |
+------------------------------------------+
|                                          |
|  当前触发词：                            |
|  +------------------------------------+  |
|  | 发送                          [x] |  |
|  | Go                            [x] |  |
|  +------------------------------------+  |
|                                          |
|  +------------------------------------+  |
|  | 添加新触发词...                    |  |
|  +------------------------------------+  |
|                                          |
|              [恢复默认]  [完成]          |
|                                          |
+------------------------------------------+
```

### 3.4 关键交互说明

**交互点1**：菜单栏图标点击
- 触发方式：单击
- 反馈形式：展开下拉菜单
- 特殊说明：图标根据状态切换（🎤 开启 / 🔇 关闭）

**交互点2**：触发词删除
- 触发方式：点击触发词后的 [x] 按钮
- 反馈形式：立即从列表移除
- 特殊说明：至少保留 1 个触发词，否则提示「至少需要保留一个触发词」

**交互点3**：添加触发词
- 触发方式：在输入框输入后按回车
- 反馈形式：添加到列表
- 特殊说明：去重检查，已存在则提示「该触发词已存在」

---

## 4. 详细设计

### 4.1 业务规则

| ID | 规则 | 说明 |
|----|------|------|
| BR-001 | 默认触发词 | "发送"、"Go"（Go 不区分大小写） |
| BR-002 | 触发词匹配 | 输入内容以触发词结尾时触发，支持中英文混合 |
| BR-003 | 触发词删除 | 触发后删除触发词本身，保留前面的内容 |
| BR-004 | 触发延迟 | 检测到触发词后等待 300ms，确认无后续输入再执行 |
| BR-005 | 开关状态 | 默认开启，状态持久化到 UserDefaults |
| BR-006 | 自定义触发词 | 用户可添加/删除触发词，至少保留 1 个 |
| BR-007 | 触发词长度 | 最短 1 字符，最长 10 字符 |
| BR-008 | 权限要求 | 需要辅助功能权限（Accessibility） |

### 4.2 接口描述

本功能为纯客户端应用，无后端接口。核心模块接口如下：

#### 模块1：InputMonitor（输入监听）

**功能说明**：监听系统输入事件，检测触发词

**输入**：
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| triggerWords | [String] | 是 | 触发词列表 |
| debounceMs | Int | 否 | 防抖延迟，默认 300ms |

**输出**：
| 字段 | 类型 | 说明 |
|------|------|------|
| onTrigger | Callback | 检测到触发词时回调，返回匹配的触发词 |

**错误处理**：
| 错误场景 | 错误码 | 用户提示 |
|----------|--------|----------|
| 无辅助功能权限 | ERR_NO_ACCESSIBILITY | 请在系统设置中授予辅助功能权限 |

---

#### 模块2：KeySimulator（按键模拟）

**功能说明**：模拟键盘按键

**输入**：
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyCode | Int | 是 | 按键码（回车 = 36） |
| deleteCount | Int | 否 | 模拟按键前先删除的字符数 |

**输出**：
| 字段 | 类型 | 说明 |
|------|------|------|
| success | Bool | 是否执行成功 |

---

#### 模块3：SettingsManager（设置管理）

**功能说明**：管理用户设置的持久化

**输入**：
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| key | String | 是 | 设置项 key |
| value | Any | 是 | 设置项值 |

**存储项**：
| Key | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| enabled | Bool | true | 功能开关 |
| triggerWords | [String] | ["发送", "Go"] | 触发词列表 |

---

### 4.3 状态流转

**状态定义**：

| 状态值 | 状态名称 | 说明 |
|--------|----------|------|
| 0 | disabled | 功能关闭，不监听输入 |
| 1 | listening | 监听中，等待触发词 |
| 2 | triggered | 已触发，等待延迟确认 |
| 3 | executing | 执行中，正在模拟按键 |

**状态流转**：

| 当前状态 | 操作 | 目标状态 | 触发条件 |
|----------|------|----------|----------|
| disabled | 开启 | listening | 用户点击开启 |
| listening | 关闭 | disabled | 用户点击关闭 |
| listening | 检测到触发词 | triggered | 输入以触发词结尾 |
| triggered | 超时确认 | executing | 300ms 内无新输入 |
| triggered | 取消 | listening | 300ms 内有新输入 |
| executing | 完成 | listening | 按键模拟完成 |

**状态流转图**：

```
+----------+    用户点击开启    +----------+
| disabled | ----------------> | listening |
+----------+ <---------------- +----------+
              用户点击关闭           |
                                    | 检测到触发词
                                    v
                              +----------+
                              | triggered | ---(有新输入)---> [返回 listening]
                              +----------+
                                    |
                                    | 300ms 无新输入
                                    v
                              +----------+
                              | executing |
                              +----------+
                                    |
                                    | 完成
                                    v
                              +----------+
                              | listening |
                              +----------+
```

---

## 5. 验收标准

| 场景 | 前置条件 | 操作步骤 | 预期结果 |
|------|----------|----------|----------|
| 正常触发 | 功能开启，触发词为默认 | 1. 在任意输入框用语音输入"你好发送" | 1. "发送"被删除 2. 回车键被触发 3. 发送内容为"你好" |
| 英文触发词 | 功能开启，触发词含 Go | 1. 输入"hello Go" | 1. "Go"被删除 2. 回车键被触发 |
| 大小写不敏感 | 功能开启 | 1. 输入"hello go" | 1. "go"被删除 2. 回车键被触发 |
| 功能关闭 | 功能关闭 | 1. 输入"你好发送" | 1. 无任何处理 2. 内容保持"你好发送" |
| 添加自定义触发词 | 功能开启 | 1. 添加触发词"OK" 2. 输入"测试OK" | 1. "OK"被删除 2. 回车键被触发 |
| 删除触发词 | 有多个触发词 | 1. 删除"Go" 2. 输入"hello Go" | 1. 无任何处理 2. 内容保持"hello Go" |
| 至少保留一个 | 只剩一个触发词 | 1. 尝试删除最后一个触发词 | 1. 提示"至少需要保留一个触发词" |
| 延迟确认 | 功能开启 | 1. 输入"你好发送" 2. 立即继续输入"补充" | 1. 不触发回车 2. 内容为"你好发送补充" |

---

## 6. 风险与依赖

### 6.1 依赖项

| 依赖内容 | 负责方 | 状态 | 降级方案 |
|----------|--------|------|----------|
| macOS 辅助功能权限 | 系统 | 需用户授权 | 提供清晰的权限引导弹窗 |
| CGEventTap API | macOS | 已就绪 | 无，核心依赖 |

### 6.2 风险评估

| 风险描述 | 概率 | 影响 | 缓解措施 |
|----------|------|------|----------|
| 用户不知道如何授权辅助功能权限 | 高 | 高 | 首次启动提供图文引导，一键跳转系统设置 |
| 输入法切换导致监听失效 | 中 | 中 | 监听多种输入事件源，兼容主流输入法 |
| 误触发（正文含触发词） | 低 | 中 | 触发词选择不常见词汇，支持自定义 |
| macOS 版本兼容性 | 低 | 中 | 支持 macOS 12+，测试覆盖主流版本 |
