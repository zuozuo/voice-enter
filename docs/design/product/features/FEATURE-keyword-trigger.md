# FEATURE-keyword-trigger

| 项目 | 内容 |
|------|------|
| 版本 | v1.1 |
| 作者 | VoiceEnter Team |
| 创建日期 | 2025-12-30 |
| 关联 | [MAIN-PRD](../MAIN-PRD.md) |

---

## 解决什么问题？

用户使用语音输入说完内容后，需要手动按回车发送，打断语音操作流程。

通过在语句末尾说出触发词（如「发送」、「Go」），系统自动删除触发词并模拟按下回车键，实现语音到发送的无缝衔接，让用户真正做到「说完即发」。

---

## 用户故事

| ID | 用户故事 | 优先级 | 验收标准 |
|----|----------|--------|----------|
| US-001 | 作为语音输入用户，我想说完内容后说「发送」就自动发送，以便无需手动按回车 | P0 | 输入"你好发送"后，自动删除"发送"并按下回车 |
| US-002 | 作为高级用户，我想自定义触发词，以便使用自己习惯的口头禅 | P1 | 可添加/删除触发词，触发词长度 1-10 字符 |
| US-003 | 作为中英文用户，我想用中文或英文触发词，以便适应不同语言习惯 | P0 | 支持中英文触发词，英文不区分大小写 |
| US-004 | 作为谨慎用户，我不想在输入过程中误触发，以便避免发送不完整的内容 | P0 | 文本变化后延迟 0.5-0.6s 再检测（防抖） |

---

## 核心流程

```
用户语音输入
      |
      v
+------------------+
| 监听器获取文本    |
| (轮询 0.15-0.2s) |
+------------------+
      |
      v
+------------------+     否
| 文本有变化？     | ---------> 继续轮询
+------------------+
      | 是
      v
+------------------+
| 防抖延迟         |
| (0.5-0.6s)       |
+------------------+
      |
      v
+------------------+     否
| 末尾有触发词？   | ---------> 继续轮询
+------------------+
      | 是
      v
+------------------+     否
| 内容非空？       | ---------> 不触发（防空消息）
+------------------+
      | 是
      v
+------------------+
| 删除触发词       |
| + 删除尾部标点   |
+------------------+
      |
      v
+------------------+
| 模拟按下回车键   |
+------------------+
      |
      v
+------------------+
| 播放触发音效     |
+------------------+
```

---

## 业务规则

| 规则 | 说明 |
|------|------|
| 触发词位置 | 必须在文本末尾（可跟随中文标点：。！？，；：～等） |
| 触发词长度 | 1-10 个字符 |
| 默认触发词 | 「发送」「Go」 |
| 英文大小写 | 不区分大小写（go、GO、Go 均可触发） |
| 中文匹配 | 精确匹配 |
| 防空消息 | 去除触发词后内容为空时不触发 |
| 防抖延迟 | 文本变化后延迟 0.5-0.6s 再检测 |
| 触发词数量 | 至少保留 1 个，可添加多个 |
| 重复检测 | 添加时检测重复（英文不区分大小写） |

---

## 验收标准

| 场景 | 前置条件 | 操作步骤 | 预期结果 |
|------|----------|----------|----------|
| 中文触发 | 默认触发词 | 输入"你好发送" | 删除"发送"，发送"你好" |
| 英文触发 | 默认触发词 | 输入"hello Go" | 删除"Go"，发送"hello" |
| 英文大小写 | 默认触发词 | 输入"test GO" | 删除"GO"，发送"test" |
| 带标点触发 | 默认触发词 | 输入"你好发送。" | 删除"发送。"，发送"你好" |
| 空内容不触发 | 默认触发词 | 输入"发送" | 不触发（内容为空） |
| 自定义触发词 | 添加"走你" | 输入"测试走你" | 删除"走你"，发送"测试" |
| 删除触发词 | 有多个触发词 | 删除"发送" | 成功删除，其他触发词仍有效 |
| 不能删除最后一个 | 只剩 1 个触发词 | 尝试删除 | 删除失败，提示保留至少 1 个 |

---

## 技术实现

### 核心组件

- `TriggerWordDetector`：触发词检测器
- `KeySimulator`：按键模拟器（CGEvent API）
- `SettingsManager`：触发词配置管理

### 关键 API

```swift
// 检测触发词
func detect(in text: String) -> TriggerDetectionResult?

// 模拟删除 + 回车
func deleteThenEnter(deleteCount: Int) -> Bool
```
