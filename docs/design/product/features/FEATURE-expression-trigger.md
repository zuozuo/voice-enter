# FEATURE-expression-trigger

| 项目 | 内容 |
|------|------|
| 版本 | v1.1 |
| 作者 | VoiceEnter Team |
| 创建日期 | 2025-12-30 |
| 关联 | [MAIN-PRD](../MAIN-PRD.md) |

---

## 解决什么问题？

用户在安静环境（图书馆、会议室）或不方便说话的场景（嗓子不舒服、旁边有人睡觉）中，无法使用语音触发词。

通过摄像头实时检测面部表情（如张嘴、撅嘴），当检测到预设表情并保持一定时间后自动触发回车，作为关键词触发的补充方案，扩展使用场景。

---

## 用户故事

| ID | 用户故事 | 优先级 | 验收标准 |
|----|----------|--------|----------|
| US-001 | 作为安静环境用户，我想通过张嘴表情触发回车，以便在图书馆也能使用语音输入 | P0 | 张嘴保持 0.3 秒后触发回车 |
| US-002 | 作为高级用户，我想选择不同的触发表情，以便使用最舒适的方式 | P1 | 支持张嘴、撅嘴等多种表情 |
| US-003 | 作为谨慎用户，我想调节触发灵敏度，以便避免日常表情误触发 | P1 | 支持灵敏度调节（75%-95%） |
| US-004 | 作为用户，我想看到表情检测状态，以便知道系统是否正常工作 | P2 | 状态栏显示人脸检测和表情强度 |

---

## 核心流程

```
摄像头捕获帧 (15fps)
        |
        v
+------------------+
|   Vision 框架    |
| 人脸特征点检测    |
+------------------+
        |
        v
+------------------+     否
|   检测到人脸？   | ---------> 重置计时，继续
+------------------+
        | 是
        v
+------------------+     否
|   是正脸？       | ---------> 重置计时（过滤侧脸）
+------------------+
        | 是
        v
+------------------+
|   分析表情系数   |
| (张嘴/撅嘴等)    |
+------------------+
        |
        v
+------------------+     否
|  系数 > 阈值？   | ---------> 重置计时，继续
+------------------+
        | 是
        v
+------------------+     否
| 持续 >= 0.3s？   | ---------> 继续计时
+------------------+
        | 是
        v
+------------------+     否
| 冷却时间已过？   | ---------> 等待冷却
+------------------+
        | 是
        v
+------------------+
|   触发回车！     |
|   播放音效       |
+------------------+
```

---

## 支持的表情

| 表情 | 标识符 | 默认阈值 | 持续时间 | 检测方式 |
|------|--------|----------|----------|----------|
| 张嘴 | mouthOpen | 15% | 0.3s | 内嘴唇上下距离/人脸高度 |
| 撅嘴 | pout | 15% | 0.3s | 嘴巴宽高比（宽变窄、高变大） |
| 左眼眨眼 | leftEyeBlink | 60% | 0.15s | 左眼高宽比变小 |
| 右眼眨眼 | rightEyeBlink | 60% | 0.15s | 右眼高宽比变小 |
| 双眼眨眼 | bothEyesBlink | 60% | 0.15s | 双眼同时闭合 |
| 挑眉 | eyebrowRaise | 30% | 0.3s | 眉毛到眼睛距离增加 |
| 微笑 | smile | 40% | 0.5s | 嘴角高于嘴巴中心 |

---

## 业务规则

| 规则 | 说明 |
|------|------|
| 帧率 | 15fps（平衡检测精度和功耗） |
| 侧脸过滤 | 人脸宽高比 < 0.5 时跳过检测 |
| 持续时间 | 表情必须持续一定时间才触发（防止瞬间表情） |
| 冷却时间 | 触发后 1 秒内不再触发（防止连续触发） |
| 权限需求 | 需要摄像头权限 |
| 独立开关 | 可单独启用/禁用，不影响关键词触发 |
| 功耗优化 | 使用 medium 分辨率，低帧率 |

---

## 验收标准

| 场景 | 前置条件 | 操作步骤 | 预期结果 |
|------|----------|----------|----------|
| 张嘴触发 | 已授权摄像头 | 张嘴保持 0.3 秒 | 触发回车，播放音效 |
| 撅嘴触发 | 选择撅嘴表情 | 撅嘴保持 0.3 秒 | 触发回车，播放音效 |
| 快速张嘴不触发 | 默认配置 | 快速张合嘴 (<0.3s) | 不触发 |
| 侧脸不触发 | 默认配置 | 侧脸张嘴 | 不触发（侧脸被过滤） |
| 冷却期不触发 | 刚触发过 | 1 秒内再次张嘴 | 不触发 |
| 关闭后不触发 | 禁用表情触发 | 张嘴 | 不触发 |
| 无摄像头权限 | 未授权 | 启动监听 | 提示授权，关键词触发仍可用 |

---

## 技术实现

### 核心组件

- `FaceExpressionMonitor`：表情监听器
- `ExpressionType`：表情类型枚举
- `ExpressionState`：表情状态（系数、是否有人脸）

### 依赖框架

- `Vision`：Apple 人脸特征点检测
- `AVFoundation`：摄像头捕获

### 关键 API

```swift
/// 支持的表情类型
public enum ExpressionType: String {
    case mouthOpen = "张嘴"
    case pout = "撅嘴"
    // ...
}

/// 开始监听
func startMonitoring() -> Bool

/// 停止监听
func stopMonitoring()

/// 请求摄像头权限
func requestCameraPermission(completion: @escaping (Bool) -> Void)
```

### 表情检测算法

**张嘴检测：**
```
mouthOpen = (innerLipsTopY - innerLipsBottomY - 0.04) / 0.15
// 正常闭嘴：0.02-0.04，张大嘴：0.15-0.25
```

**撅嘴检测：**
```
pout = (6.0 - mouthWidth / mouthHeight) / 3.0
// 正常宽高比 > 6，撅嘴宽高比 < 5
```

---

## 配置选项

| 配置项 | 默认值 | 范围 | 说明 |
|--------|--------|------|------|
| triggerExpression | mouthOpen | 7种表情 | 触发表情类型 |
| threshold | 0.15 | 0.05-0.5 | 触发阈值（越低越灵敏） |
| minDuration | 0.3s | 0.1-1.0s | 最小持续时间 |
| cooldown | 1.0s | 0.5-3.0s | 冷却时间 |
| isExpressionTriggerEnabled | true | 开/关 | 功能开关 |
