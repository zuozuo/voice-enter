# VoiceEnter 产品需求文档 (PRD)

## 文档信息

| 属性 | 值 |
|------|-----|
| 产品名称 | VoiceEnter |
| 版本 | 1.1 |
| 作者 | VoiceEnter Team |
| 更新日期 | 2025-12 |
| 状态 | MVP 已完成 |

---

## 1. 产品概述

### 1.1 产品定位

VoiceEnter 是一款 macOS 菜单栏工具，专为语音输入场景设计。通过两种创新的触发方式——**关键词触发**和**面部表情触发**——实现完全免手操作的消息发送体验。

### 1.2 目标用户

| 用户群体 | 使用场景 | 核心诉求 |
|---------|---------|---------|
| 语音输入用户 | 使用 macOS 听写功能输入文字 | 输入完成后无需手动按回车 |
| AI 编程助手用户 | 与 Claude Code、Cursor、Copilot Chat 交互 | 语音提问后自动发送 |
| 终端开发者 | 在 Kitty/Terminal 中执行命令 | 语音输入命令后自动执行 |
| 无障碍用户 | 行动不便，依赖语音操作 | 减少键盘依赖 |
| 效率追求者 | 追求全语音操作流程 | 连续语音操作，不中断 |
| 特殊姿势用户 | 躺着编程、站立办公、手部被占用 | 解放双手 |

### 1.3 产品愿景

> 让语音输入真正解放双手，说完即发，零手动操作。

### 1.4 核心价值

1. **零学习成本** - 自然语言触发词，无需记忆复杂命令
2. **多场景适配** - 支持终端、浏览器、备忘录等多种应用
3. **隐私优先** - 全部本地处理，无数据上传
4. **轻量高效** - 菜单栏工具，低资源占用

---

## 2. 需求背景

### 2.1 问题描述

使用 macOS 语音输入（听写功能）时，存在以下痛点：

1. **操作中断** - 语音输入完内容后，必须用手按回车发送
2. **体验割裂** - 语音 → 键盘 → 语音的切换打断流畅体验
3. **效率降低** - 对于需要频繁发送消息的场景，手动回车成为瓶颈
4. **无障碍受限** - 行动不便用户无法完全脱离键盘
5. **姿势限制** - 躺着、站立、手被占用时无法操作键盘

### 2.2 解决方案

#### 方案 A：关键词触发（已实现）

```
用户说: "帮我查一下天气发送"
           └──────────────┴── 触发词

系统执行:
1. 检测到触发词 "发送"
2. 删除 "发送" 两个字符
3. 模拟按下回车键
4. 播放提示音反馈
5. 消息发送成功
```

#### 方案 B：面部表情触发（已实现）

```
用户动作: 张嘴保持 0.3 秒
          └──── 表情触发

系统执行:
1. 摄像头检测到张嘴表情
2. 检测值超过阈值且持续足够时间
3. 模拟按下回车键
4. 播放提示音反馈
5. 消息发送成功
```

---

## 3. 功能需求

### 3.1 核心功能

#### F1: 触发词检测

| 需求ID | 描述 | 优先级 | 状态 |
|-------|------|-------|------|
| F1.1 | 支持自定义多个触发词 | P0 | ✅ 已完成 |
| F1.2 | 支持中文和英文触发词 | P0 | ✅ 已完成 |
| F1.3 | 触发词匹配不区分英文大小写 | P1 | ✅ 已完成 |
| F1.4 | 触发词后可跟随标点符号（会一并删除） | P1 | ✅ 已完成 |
| F1.5 | 触发词长度限制（1-10 字符） | P2 | ✅ 已完成 |
| F1.6 | 防止空消息触发（内容为空时不触发） | P1 | ✅ 已完成 |

**默认触发词：** `发送`、`Go`

**触发词扩展示例（用户可自定义）：**
- `gogogo`
- `发送发送`
- `走你`
- `886`
- `就这样吧`

#### F2: 自动操作

| 需求ID | 描述 | 优先级 | 状态 |
|-------|------|-------|------|
| F2.1 | 检测到触发词后，删除触发词字符 | P0 | ✅ 已完成 |
| F2.2 | 删除操作包含尾部标点符号 | P1 | ✅ 已完成 |
| F2.3 | 删除完成后自动发送回车键 | P0 | ✅ 已完成 |
| F2.4 | 防抖处理，避免重复触发（0.5-0.6秒） | P0 | ✅ 已完成 |
| F2.5 | 触发后播放提示音效 | P1 | ✅ 已完成 |

#### F3: 多场景监听

| 需求ID | 监听模式 | 技术方案 | 优先级 | 状态 |
|-------|---------|---------|-------|------|
| F3.1 | Kitty 终端 | `kitty @ get-text` API | P0 | ✅ 已完成 |
| F3.2 | Terminal.app | AppleScript | P1 | ✅ 已完成 |
| F3.3 | 通用应用 | Accessibility API | P1 | ✅ 已完成 |
| F3.4 | 面部表情 | Vision + AVFoundation | P2 | ✅ 已完成 |

#### F4: 触发范围控制

| 需求ID | 描述 | 优先级 | 状态 |
|-------|------|-------|------|
| F4.1 | 仅 Kitty 模式：只在 Kitty 终端中触发 | P0 | ✅ 已完成 |
| F4.2 | 仅终端模式：在 Kitty + Terminal.app 中触发 | P1 | ✅ 已完成 |
| F4.3 | 所有应用模式：在任何应用中触发 | P1 | ✅ 已完成 |
| F4.4 | 默认使用"仅 Kitty"模式（最安全） | P0 | ✅ 已完成 |

### 3.2 面部表情触发功能

#### F7: 面部表情触发

| 需求ID | 描述 | 优先级 | 状态 |
|-------|------|-------|------|
| F7.1 | 支持张嘴表情触发回车 | P2 | ✅ 已完成 |
| F7.2 | 支持撅嘴表情触发 | P2 | ✅ 已完成 |
| F7.3 | 支持眨眼表情触发（左/右/双眼） | P3 | ✅ 已完成 |
| F7.4 | 支持挑眉表情触发 | P3 | ✅ 已完成 |
| F7.5 | 支持微笑表情触发 | P3 | ✅ 已完成 |
| F7.6 | 表情灵敏度调节（0-100%） | P2 | ✅ 已完成 |
| F7.7 | 表情触发持续时间要求（防误触） | P2 | ✅ 已完成 |
| F7.8 | 表情触发冷却时间（1秒） | P2 | ✅ 已完成 |
| F7.9 | 实时表情检测值显示 | P2 | ✅ 已完成 |
| F7.10 | 侧脸自动过滤（防误触） | P2 | ✅ 已完成 |

**支持的表情类型：**

| 表情 | 标识符 | 默认阈值 | 默认持续时间 |
|------|--------|---------|-------------|
| 张嘴 | mouthOpen | 15% (85%灵敏度) | 0.3秒 |
| 撅嘴 | pout | 15% (85%灵敏度) | 0.3秒 |
| 左眼眨眼 | leftEyeBlink | 60% | 0.15秒 |
| 右眼眨眼 | rightEyeBlink | 60% | 0.15秒 |
| 双眼眨眼 | bothEyesBlink | 60% | 0.15秒 |
| 挑眉 | eyebrowRaise | 30% | 0.3秒 |
| 微笑 | smile | 40% | 0.5秒 |

### 3.3 界面功能

#### F5: 菜单栏界面

| 需求ID | 描述 | 优先级 | 状态 |
|-------|------|-------|------|
| F5.1 | 菜单栏图标，点击展开控制面板 | P0 | ✅ 已完成 |
| F5.2 | 关键词触发启用/禁用开关 | P0 | ✅ 已完成 |
| F5.3 | 触发词列表展示和管理 | P0 | ✅ 已完成 |
| F5.4 | 添加/删除触发词 | P0 | ✅ 已完成 |
| F5.5 | 触发范围选择器（分段控件） | P0 | ✅ 已完成 |
| F5.6 | 实时状态显示（监听中/已停止） | P1 | ✅ 已完成 |
| F5.7 | 表情触发启用/禁用开关 | P1 | ✅ 已完成 |
| F5.8 | 表情类型选择器 | P1 | ✅ 已完成 |
| F5.9 | 灵敏度滑块 | P1 | ✅ 已完成 |
| F5.10 | 实时检测值进度条 | P1 | ✅ 已完成 |
| F5.11 | 触发音效选择 | P1 | ✅ 已完成 |
| F5.12 | 退出应用按钮 | P0 | ✅ 已完成 |
| F5.13 | 主题模式切换（跟随系统/浅色/深色） | P2 | ✅ 已完成 |

#### F6: 视觉设计

| 需求ID | 描述 | 优先级 | 状态 |
|-------|------|-------|------|
| F6.1 | 支持深色/浅色主题，符合 macOS 风格 | P0 | ✅ 已完成 |
| F6.2 | 卡片式布局，信息层级清晰 | P1 | ✅ 已完成 |
| F6.3 | 触发词使用标签样式展示 | P1 | ✅ 已完成 |
| F6.4 | 状态指示器（绿色/红色圆点） | P1 | ✅ 已完成 |
| F6.5 | 悬停动画反馈 | P2 | ✅ 已完成 |
| F6.6 | 渐变色调点缀（青色→蓝色） | P2 | ✅ 已完成 |
| F6.7 | 流式布局（FlowLayout）展示触发词 | P2 | ✅ 已完成 |

### 3.4 音效功能

#### F8: 触发音效

| 需求ID | 描述 | 优先级 | 状态 |
|-------|------|-------|------|
| F8.1 | 支持 13 种系统音效 | P1 | ✅ 已完成 |
| F8.2 | 支持关闭音效 | P1 | ✅ 已完成 |
| F8.3 | 选择音效时预览播放 | P2 | ✅ 已完成 |
| F8.4 | 音效设置持久化 | P1 | ✅ 已完成 |

**支持的音效：**
- 无 (静音)
- Tink (默认)
- Pop
- Ping
- Glass
- Blow
- Bottle
- Frog
- Funk
- Morse
- Purr
- Sosumi
- Submarine
- Hero

---

## 4. 非功能需求

### 4.1 性能要求

| 指标 | 要求 | 实际表现 |
|------|------|---------|
| 触发响应延迟 | < 200ms | ✅ 达标 |
| CPU 占用（空闲） | < 1% | ✅ 达标 |
| CPU 占用（监听中） | < 5% | ✅ 达标 |
| 内存占用 | < 50MB | ✅ 达标 |
| 文本轮询间隔 | 150-200ms | ✅ 达标 |
| 摄像头帧率 | 15fps | ✅ 达标（省电） |

### 4.2 兼容性要求

| 项目 | 要求 |
|------|------|
| macOS 版本 | 13.0 (Ventura) 及以上 |
| 架构 | Apple Silicon (arm64) + Intel (x86_64) |
| Kitty 版本 | 支持远程控制的版本 |
| 摄像头 | 内置或外置摄像头 / iPhone 连续互通相机 |

### 4.3 安全与隐私

| 项目 | 说明 |
|------|------|
| 数据存储 | 仅存储设置到 UserDefaults，无云端 |
| 权限申请 | 辅助功能（必需）、摄像头（可选） |
| 隐私声明 | 不收集、不上传任何用户数据 |
| 面部数据 | 本地处理，不存储图像，只提取表情系数 |
| 外部依赖 | 无，全部使用 Apple 原生框架 |

---

## 5. 用户故事

### US1: 基础语音发送

> 作为一个语音输入用户，我希望说完内容后说"发送"就能自动发送消息，这样我就不需要用手按回车了。

**验收标准：**
- [x] 在 Kitty 终端中语音输入 "你好发送"
- [x] 系统自动删除 "发送" 并按下回车
- [x] 播放提示音效
- [x] 消息成功发送

### US2: 触发词管理

> 作为一个高级用户，我希望能自定义触发词，这样我可以使用自己习惯的口头禅来触发发送。

**验收标准：**
- [x] 可以添加新触发词（如 "走你"）
- [x] 可以删除已有触发词
- [x] 至少保留一个触发词
- [x] 新触发词立即生效
- [x] 设置持久化保存

### US3: 安全使用

> 作为一个谨慎的用户，我担心在其他应用中误触发，希望能限制触发范围只在终端中生效。

**验收标准：**
- [x] 可以选择 "仅 Kitty" 模式
- [x] 在 Kitty 中触发词正常生效
- [x] 在其他应用中输入触发词不会触发
- [x] 可随时切换触发范围

### US4: 表情触发

> 作为一个喜欢新奇功能的用户，我希望通过做表情（如张嘴）来触发发送，这样在不方便说话的场景下也能使用。

**验收标准：**
- [x] 授权摄像头后可启用表情触发
- [x] 张嘴保持 0.3 秒后触发回车
- [x] 有冷却时间防止连续触发
- [x] 可选择其他表情类型
- [x] 可调节灵敏度

### US5: 视觉反馈

> 作为一个注重体验的用户，我希望在触发时有音效和视觉反馈，这样我知道系统已经响应了我的操作。

**验收标准：**
- [x] 触发时播放提示音
- [x] 可选择不同音效
- [x] 显示最近触发的触发词
- [x] 状态指示器实时显示监听状态

### US6: 无摄像头场景

> 作为一个使用 Mac mini 的用户，我的电脑没有内置摄像头，希望系统能提示我如何使用表情触发功能。

**验收标准：**
- [x] 检测到无摄像头时显示友好提示
- [x] 提示用户可以通过 iPhone 连续互通相机使用
- [x] 不影响关键词触发功能正常使用

---

## 6. 竞品分析

| 产品 | 方案 | 优点 | 缺点 |
|------|------|------|------|
| macOS 语音控制 | 系统级语音命令 | 系统集成 | 需要说"按回车"，不自然 |
| Talon Voice | 语音编程工具 | 功能强大 | 学习成本高，配置复杂 |
| Whisper Flow | 语音转文字 | 转录准确 | 无自动发送功能 |
| **VoiceEnter** | 触发词+表情监听 | 简单直观、多种触发方式、零学习成本 | 需要特定触发词或表情 |

**VoiceEnter 差异化优势：**
1. 双触发机制（关键词 + 表情）
2. 零学习成本，自然语言触发
3. 多场景适配（终端、浏览器、通用应用）
4. 完全本地处理，隐私安全

---

## 7. 发布计划

### 7.1 MVP (v1.0) ✅ 已完成

- [x] Kitty 终端监听
- [x] Terminal.app 监听
- [x] 通用应用监听 (Accessibility API)
- [x] 触发词检测和自动回车
- [x] 菜单栏 UI（完整功能）
- [x] 触发词管理（增删）
- [x] 触发范围控制
- [x] 设置持久化
- [x] 62 个单元测试

### 7.2 v1.1 ✅ 已完成

- [x] 面部表情触发功能
- [x] 支持 7 种表情类型
- [x] 灵敏度调节
- [x] 实时检测值显示
- [x] 侧脸过滤防误触
- [x] 触发音效功能
- [x] 13 种系统音效可选
- [x] 主题模式切换
- [x] 无摄像头检测和提示

### 7.3 v1.2 (计划中)

- [ ] 应用图标设计
- [ ] DMG 打包分发
- [ ] 开机自启动
- [ ] 全局快捷键（暂停/恢复监听）
- [ ] 更多表情类型（吐舌头、皱鼻）

### 7.4 v2.0 (计划中)

- [ ] 多语言支持
- [ ] 自定义动作（不只是回车）
- [ ] 快捷键触发
- [ ] 使用统计数据
- [ ] 硬件方案（ESP32-C3 蓝牙遥控器）

---

## 8. 技术实现概览

### 8.1 核心技术栈

| 层级 | 技术 |
|------|------|
| 语言 | Swift 5.9 |
| UI 框架 | SwiftUI |
| 架构模式 | MVVM + Observer |
| 包管理 | Swift Package Manager |
| 平台 | macOS 13.0+ |

### 8.2 核心 API

| 功能 | API |
|------|-----|
| 按键模拟 | CGEvent API |
| 辅助功能 | Accessibility API |
| 摄像头采集 | AVFoundation |
| 人脸检测 | Vision Framework |
| 终端监控 | Kitty Remote Control / AppleScript |

---

## 9. 附录

### 9.1 术语表

| 术语 | 定义 |
|------|------|
| 触发词 | 用户说出后触发自动回车的特定词语 |
| 防抖 | 延迟执行，避免文本变化过程中频繁触发 |
| 冷却时间 | 触发后的等待时间，防止连续触发 |
| 轮询 | 定时检查文本内容是否变化 |
| 表情系数 | 面部表情的检测强度值（0.0-1.0） |
| 阈值 | 触发表情所需的最小系数值 |
| 侧脸过滤 | 当检测到用户侧脸时跳过表情检测，防止误触 |

### 9.2 参考资料

- [macOS Accessibility API](https://developer.apple.com/documentation/applicationservices/accessibility)
- [Kitty Remote Control](https://sw.kovidgoyal.net/kitty/remote-control/)
- [Apple Vision Framework](https://developer.apple.com/documentation/vision)
- [AVFoundation Camera Capture](https://developer.apple.com/documentation/avfoundation/capture_setup)
- [CGEvent Reference](https://developer.apple.com/documentation/coregraphics/cgevent)

### 9.3 更新历史

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| 1.0 | 2024-12 | 初始版本，关键词触发 MVP |
| 1.1 | 2025-12 | 添加表情触发、音效功能、主题切换 |
